# Сценарии тестирования бота (Telegram, aiogram v3)
# Категории автоматически определяются по префиксу ID (B1, B2, ...)
# Формат элемента: id / desc / category / priority

# B1 — Базовые команды и меню
- id: "B1.1"
  desc: "Команда /start: показ главного меню без ошибок"
  category: "Базовые команды"
  priority: "critical"

- id: "B1.2"
  desc: "Кнопка «Моя подписка»: для незарегистрированного пользователя — сообщение об отсутствии подписки"
  category: "Базовые команды"
  priority: "high"

- id: "B1.3"
  desc: "Кнопка «Продлить подписку»: отображение списка активных планов (по bot_id)"
  category: "Базовые команды"
  priority: "high"

- id: "B1.4"
  desc: "Кнопка «Помощь»: вывод справочного текста и возврат в меню"
  category: "Базовые команды"
  priority: "normal"

# B2 — Статус подписки
- id: "B2.1"
  desc: "Активная подписка: корректное отображение плана, дат начала/окончания, последней оплаты"
  category: "Статус подписки"
  priority: "critical"

- id: "B2.2"
  desc: "Просроченная подписка: статус expired, предложение продлить"
  category: "Статус подписки"
  priority: "high"

- id: "B2.3"
  desc: "Наличие нескольких подписок в истории: отображается актуальная (по updated_at)"
  category: "Статус подписки"
  priority: "normal"

# B3 — Создание инвойса через Django API
- id: "B3.1"
  desc: "Выбор тарифа → POST /create-invoice → получен invoiceUrl"
  category: "Интеграция с платежами"
  priority: "critical"

- id: "B3.2"
  desc: "Ошибка API (HTTP 5xx/битый JSON) при создании инвойса: корректное сообщение пользователю (alert)"
  category: "Интеграция с платежами"
  priority: "high"

- id: "B3.3"
  desc: "План выключен (enabled=False): тариф не отображается в списке"
  category: "Интеграция с платежами"
  priority: "normal"

# B4 — Уведомления после оплаты (webhook обрабатывает Django)
- id: "B4.1"
  desc: "После APPROVED: бот отправляет одно подтверждение о продлении/активации"
  category: "После оплаты"
  priority: "critical"

- id: "B4.2"
  desc: "Повторный APPROVED того же orderReference в рамках одной сессии: бот не шлёт дубликат уведомления"
  category: "После оплаты"
  priority: "critical"

- id: "B4.3"
  desc: "Неуспешные/промежуточные статусы (DECLINED/REFUNDED/EXPIRED/PENDING/IN_PROCESS/WAITING_AUTH_COMPLETE): бот не шлёт 'успех'"
  category: "После оплаты"
  priority: "high"

# B5 — Бан и ограничения доступа
- id: "B5.1"
  desc: "Пользователь is_blocked=True: любые действия отвечают 'Доступ запрещён'"
  category: "Доступ/бан"
  priority: "critical"

- id: "B5.2"
  desc: "Разбан после is_blocked=True: функциональность восстанавливается"
  category: "Доступ/бан"
  priority: "high"

# B6 — Идемпотентность уведомлений бота
- id: "B6.1"
  desc: "Два одинаковых APPROVED (повторная доставка/после рестарта процесса): одно уведомление пользователю"
  category: "Идемпотентность"
  priority: "critical"

- id: "B6.2"
  desc: "Одновременно APPROVED и затем DECLINED по тому же orderReference: уведомление об успехе не отзывается"
  category: "Идемпотентность"
  priority: "high"

# B7 — Многоботность (изоляция по bot_id)
- id: "B7.1"
  desc: "Планы и статусы отображаются согласно текущему BOT_ID (нет утечки планов другого бота)"
  category: "Многоботность"
  priority: "critical"

- id: "B7.2"
  desc: "Один пользователь в двух ботах: независимые статусы/списки планов"
  category: "Многоботность"
  priority: "high"

# B8 — Планировщик и напоминания (если включено)
- id: "B8.1"
  desc: "Рассылка напоминания об окончании подписки за N дней: сообщение отправлено один раз"
  category: "Планировщик"
  priority: "normal"

- id: "B8.2"
  desc: "Планировщик не шлёт DM заблокированным пользователям"
  category: "Планировщик"
  priority: "normal"

# B9 — Отказоустойчивость сети
- id: "B9.1"
  desc: "Сетевой сбой при обращении к Django API (соединение/DNS/timeout): корректная обработка и сообщение пользователю"
  category: "Сеть/ошибки"
  priority: "high"

- id: "B9.2"
  desc: "Повтор запроса create-invoice после временного сбоя: успешное получение URL"
  category: "Сеть/ошибки"
  priority: "normal"

# B10 — Логи/аудит
- id: "B10.1"
  desc: "Действия бота логируются (start, статус, оплата, ошибки) в файл логов бота"
  category: "Логи"
  priority: "normal"

- id: "B10.2"
  desc: "Ошибки API/DB содержат достаточный контекст (bot_id, user_id, plan_id, orderReference)"
  category: "Логи"
  priority: "normal"
